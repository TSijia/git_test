# 像素坐标到实际坐标的映射

## 单目视觉标定

*    **运行环境** VS2017 + Opencv3.4
*    **参考资料**
     *    [Opencv官网标定原理介绍](https://docs.opencv.org/2.4/doc/tutorials/calib3d/camera_calibration/camera_calibration.html)
     *    [张正友标定译文](https://blog.csdn.net/heroacool/article/details/50286677)
     *    [一篇单目定位的文章，有帮助](http://html.rhhz.net/CHTB/html/2018-2-35.htm)
     *    博客
*    **目的：**获取摄像头的内参和外参矩阵以及相机畸变系数，对一个摄像头来说，只要分辨率不变，那么内参矩阵和畸变系数是一定的，外参矩阵由相机坐标系和世界坐标系决定。

*    **主要步骤：**
     *    1.准备标定板，这里是选定的黑白相间的棋盘图（精度对结果有影响，查资料说理论上是内角点要是7*7或者更多结果比较好），标定板需要在不同位置、不同角度、不同姿态下拍摄，标定板图片以10~20张为宜（该标定方法设定世界坐标系在标定板平面，标定板平面Zw = 0）
     *    Opencv
          *  提取图像角点像素坐标，找到对应的点的世界坐标系坐标（我觉得原理也是类似找几对对应的点求出一个比例关系，但是这个方法不用限制摄像头角度）
          *  相机标定
          *  对标定结果做评价
          *  图像矫正

* **实施过程**
    *    张正友标定的方法网上有很多资料，我在例程的基础上进行修改和调整，因为考虑棋盘精度的问题，所以图片也是用的找到的棋盘标定图
    *    提取内角点findChessboardCorners并进行亚像素精确化find4QuadCornerSubpix
    *    得到对应的世界坐标系下坐标（Xw,Yw），实际的棋盘的每一个格子的宽度是要知道的，以毫米为单位，这个上面是10毫米;下图是以一幅图为例，在程序中的像素坐标和实际的坐标表示，在这样的坐标下选取对应的像素坐标和实际坐标
    
        <div align="center" title = "area_id">
        <img src="https://raw.githubusercontent.com/TSijia/git_test/master/图片2.png"  alt="模型" align=center  />
        </div>

        <div align="center" title = "area_id">
        <img src="https://raw.githubusercontent.com/TSijia/git_test/master/图片3.png"  alt="模型" align=center  />
        </div>

    *    相机标定calibrateCamera，得到内参矩阵，畸变矩阵，旋转向量，平移向量；旋转向量再经过进一步的转换得到对应的旋转矩阵
    *    标定结果评定projectPoints，Opencv中提供这样的函数接口，来根据内外参数矩阵以及畸变矩阵来进行三维空间到二位空间的重投影计算
    *    图片矫正使用initUndistortRectifyMap结合remap的方法，是因为这种方法要比undistort性能上要优一些;这有一个需要注意的地方，求出来的畸变矩阵排列[K1,K2,P1,P2,K3],K为径向畸变，P为切像畸变，一般K3对应的非线性比较剧烈，估计的不好容易产生扭曲，所以在矫正之前，将K3值赋为了0（如果对鱼眼摄像头加上K3可能比较好），这个也是之前的结果正确的原因

        <div align="center" title = "area_id">
        <img src="https://raw.githubusercontent.com/TSijia/git_test/master/图片4.png"  alt="模型" align=center  />
        </div>

        <div align="center" title = "area_id">
        <img src="https://raw.githubusercontent.com/TSijia/git_test/master/图片5.png"  alt="模型" align=center  />
        </div>

        <div align="center" title = "area_id">
        <img src="https://raw.githubusercontent.com/TSijia/git_test/master/图片6.png"  alt="模型" align=center  />
        </div>   
    *    得到的参数结果保存在caliberation_result.txt中
    
        <div align="center" title = "area_id">
        <img src="https://raw.githubusercontent.com/TSijia/git_test/master/图片1.png"  alt="模型" align=center  />
        </div>

    *    测试结果
         *    参考上面**参考资料**中的第三篇文章中第三章目标定位根据旋转矩阵和平移向量算出映射矩阵M，根据下面的两个等式将像素点坐标带进去，算出对应的Xw,Yw,计算偏差

        <div align="center" title = "area_id">
        <img src="https://raw.githubusercontent.com/TSijia/git_test/master/图片7.png"  alt="模型" align=center  />
        </div>  
        
        *    测试结果1（对比原图片，我还是以内角点坐标作为测试的）

             |  像素点坐标(像素)  | 期望世界坐标系坐标(Z=0)(毫米) | 实际计算世界坐标系(毫米) |    误差(x,y)(毫米)    |
             |------------------|-----------------------------|-----------------------|----------------------| 
             | (494.524,92.015) |             (0,0)           |      (0.287,1.067)    |     (0.287,1.067)    | 
             | (497.357,126.214)|             (0,10)          |      (0.118,11.175)   |     (0.118,1.175)    |
             | (499.278,161.278)|             (0,20)          |      (0.277，20.959)  |     (0.277,0.959)    |
             | (502.390,198.525)|             (0,30)          |     (0.244，30.843)   |     (0.244,0.843)    |
             | (443.585,96.307) |             (10,0)          |     (10.150，0.765)   |     (0.150,0.765)    |
             | (446.000,131.00) |             (10,10)         |     (9.949，11.044)   |     (0.051,1.044)    |
             | (446.722,166.278)|             (10,20)         |     (10.080，20.909)  |     (0.080,0.909)    |
             | (448.000,204.00) |             (10,30)         |     (10.120,30.922)   |     (0.120,0.922)    |
             | (234.986,224.643)|             (50,30)         |     (49.804,31.031)   |     (0.196,1.031)    |

        * 测试结果2（对比矫正过的图片）
      
             |  像素点坐标(像素)  | 期望世界坐标系坐标(Z=0)(毫米) | 实际计算世界坐标系(毫米) |    误差(x,y)(毫米)    |
             |------------------|-----------------------------|-----------------------|----------------------| 
             | (498.567,92.997) |             (0,0)           |      (-0.628,1.513)   |     (-0.628,1.513)   | 
             | (501.500,126.874)|             (0,10)          |      (-0.662,11.484)  |     (-0.662,1.484)   |
             | (504.500,163.00) |             (0,20)          |      (-0.658,21.563)  |     (-0.658,1.563)   |
             | (507.000,201.00) |             (0,30)          |     (-0.545,31.587)   |     (-0.545,1.587)   |
             | (447.227,97.773) |             (10,0)          |       (9.445,1.323)   |     (0.555,1.323)    |
             | (448.500,132.00) |             (10,10)         |      (9.478,11.403)   |     (0.522,1.403)    |
             | (449.300,168.30) |             (10,20)         |      (9.614,21.527)   |     (0.386,1.527)    |
             | (451.000,206.00) |             (10,30)         |      (9.590,31.509)   |     (0.410,1.509)    |
             | (230.936,227.022)|             (50,30)         |     (50.531,31.554)   |     (0.531,1.554)    |

        * 测试结果分析
            *    如果不考虑摄像头的畸变其实像素坐标与实际坐标之间的关系应该是线性的，但是引入畸变后关系就变成了非线性，按照理论来说应该是测试结果2比测试结果效果要好一点，但是结果不是这样我分析可能原因有两点：
                 *    1.选用的棋盘图片内角点为4\*6，比要求的\7*7还要少，可能会影响畸变系数的求取
                 *    2.我的测试方法存在问题
               
*  **接下来的工作**
    *    从二维到三维，我的一个比较简单的想法是，学长给我看的视频中是机械臂在桌面上分拣不同颜色的圆片，那么上述的标定工作我认为可以是求出了桌面的坐标系，如果想让机械手来准确的定位圆片的三维坐标系，那么可以规定好机械臂的底座坐标系作为世界坐标系，最后转换成机械手的端点坐标系、桌面坐标系、世界坐标系的一个坐标转换问题，不过我还没有详细了解原理以及这个机械臂工作的条件（摄像头是否固定之类的），所以还需要查资料和咨询学长
    *    关于畸变问题，我不知道采用的摄像头的畸变是否严重，如果畸变严重的话还要对矫正的图像进行相应的裁剪